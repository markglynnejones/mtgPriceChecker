name: Weekly CSV Upload

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 18 * * 0"  # Sunday 18:00 Europe/London

permissions:
  contents: write

jobs:
  weekly-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Generate weekly snapshot CSV
        run: |
          python tracker.py \
            --csv collection/moxfield.csv \
            --tz Europe/London \
            --export-csv data/weekly/weekly_snapshot_latest.csv \
            --no-alerts \
            --no-discord

      - name: Copy to dated snapshot
        run: |
          mkdir -p data/weekly/snapshots
          DATE=$(date -u +%F)  # YYYY-MM-DD
          cp data/weekly/weekly_snapshot_latest.csv "data/weekly/snapshots/${DATE}.csv"

      - name: Commit weekly snapshot files
        run: |
          git config user.name "mtg-alert-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/weekly/weekly_snapshot_latest.csv data/weekly/snapshots/*.csv
          git commit -m "Weekly snapshot" || echo "No changes to commit"
          git push

      - name: Upload CSV to Discord (with summary)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python weekly_upload.py --file data/weekly/weekly_snapshot_latest.csv --snapshots-dir data/weekly/snapshots --tz Europe/London
